name: Deploy Staging with Command

on:
  issue_comment:
    types: [created]

jobs:
  build_and_deploy:
    if: |
      github.event.issue.pull_request &&
      startsWith(github.event.comment.body, '/staging') &&
      (github.actor == 'usachoco')
    runs-on: ubuntu-latest
    permissions:
      contents: write
      pull-requests: write

    steps:
      - name: Checkout Main Repository
        uses: actions/checkout@v4
        with:
          ref: ${{ github.event.issue.pull_request.head.sha }}  # æœ€æ–°ã®PRã®çŠ¶æ…‹ã‚’å–å¾—ã™ã‚‹
          token: ${{ secrets.GITHUB_TOKEN }}
          fetch-depth: 0

      - name: Setting Local contents
        run: |
          mkdir tmp_contents
          mv ./data ./workspace README.md tmp_contents

      - name: Deploy to Staging Repository
        env:
          PAT_TOKEN: ${{ secrets.PAT_TOKEN }}
        run: |
          # ã‚¢ã‚«ã‚¦ãƒ³ãƒˆè¨­å®š
          git config --global user.name "github-actions[bot]"
          git config --global user.email "github-actions[bot]@users.noreply.github.com"

          # ãƒªãƒã‚¸ãƒˆãƒªã‚¯ãƒ­ãƒ¼ãƒ³
          rm -rf staging_repo
          git clone https://x-access-token:${{ secrets.PAT_TOKEN }}@github.com/usachoco/staging-sandbox.git staging_repo
          cd staging_repo

          # æ—¢å­˜ã®ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ã™ã¹ã¦å‰Šé™¤ã—ã€æ–°ã—ã„ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ã‚³ãƒ”ãƒ¼
          rm -rf *
          mv ../tmp_contents/* .
          
          git add .
          git commit -m "Deploy from ratorio staging branch" || true
          git push origin main

      - name: Comment on PR with preview URL
        uses: actions/github-script@v6
        with:
          script: |
            const prNumber = context.payload.issue.number;
            const stagingRepoUrl = 'https://github.com/usachoco/staging-sandbox';
            const previewUrl = `${stagingRepoUrl}/tree/pr-${prNumber}`;
            
            github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: prNumber,
              body: `ğŸš€ PRãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ç’°å¢ƒãŒãƒ‡ãƒ—ãƒ­ã‚¤ã•ã‚Œã¾ã—ãŸï¼\n\n[stagingãƒªãƒã‚¸ãƒˆãƒªã®ãƒ–ãƒ©ãƒ³ãƒ](${previewUrl})`
            });
